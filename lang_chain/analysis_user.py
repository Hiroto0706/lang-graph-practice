from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

class AnalysisUser:
    def __init__(self, llm: ChatOpenAI):
        self.llm = llm

    def run(self, user_input: str) -> str:
        # プロンプトテンプレートを定義
        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "あなたはユーザーの質問から、ユーザーがどんな人かを分析する専門家です。",
                ),
                (
                    "human",
                    "以下のユーザーが答えた質問から、ユーザーがどう言った人物かを分析してください。\n\n"
                    "ユーザーの回答: {user_input}\n\n"
                    "ユーザーの入力した内容から、ユーザーがどんな人物で、どういった性格かを分析してください。また、与えられた情報から導き出されるユーザーのインサイトも生成してください。"
                    "\n\n以下のMBTI別分析も参考にしてください：\n\n"
                    "---\n\n"
                    "## 🧠 Analysts（分析家タイプ）\n\n"
                    "---\n\n"
                    "### **INTJ（建築家）**\n"
                    "- **どんな人？**：戦略家。未来の可能性を常に見据え、冷静に計画を立てて行動するタイプ。\n"
                    "- **傾向**：感情よりも論理を重視。独創的で一人で黙々と作業できる環境が好き。\n"
                    "- **特徴**：長期的なビジョンに忠実。非合理なものが大嫌い。\n"
                    "- **著名人**：イーロン・マスク、ニーチェ、坂本龍馬\n\n"
                    "---\n\n"
                    "### **INTP（論理学者）**\n"
                    "- **どんな人？**：独自の理論とアイデアを愛する思想家タイプ。\n"
                    "- **傾向**：好奇心旺盛でマイペース。正解より「なぜ？」を重視する。\n"
                    "- **特徴**：型にハマらない天才肌。外界より内面に熱中。\n"
                    "- **著名人**：アルベルト・アインシュタイン、村上春樹、渋沢栄一\n\n"
                    "---\n\n"
                    "### **ENTJ（指揮官）**\n"
                    "- **どんな人？**：行動的なリーダー。最短でゴールに向かう戦略家。\n"
                    "- **傾向**：計画・実行・成果を重視。誰よりも行動が早い。\n"
                    "- **特徴**：自他ともに厳しい完璧主義者。弱音は吐かない。\n"
                    "- **著名人**：スティーブ・ジョブズ、明石家さんま、ナポレオン\n\n"
                    "---\n\n"
                    "### **ENTP（討論者）**\n"
                    "- **どんな人？**：自由奔放な発明家。議論で世界を広げる挑戦者。\n"
                    "- **傾向**：アイデアが止まらない。刺激と新しさを求めて動き続ける。\n"
                    "- **特徴**：ルール破りの天才。マンネリが一番の敵。\n"
                    "- **著名人**：トーマス・エジソン、アドラー、爆笑問題・太田\n\n"
                    "---\n\n"
                    "## 🌱 Diplomats（理想主義者タイプ）\n\n"
                    "---\n\n"
                    "### **INFJ（提唱者）**\n"
                    "- **どんな人？**：世の中を良くしたいと本気で思っている理想主義者。\n"
                    "- **傾向**：少人数の深い人間関係を重視。内に熱い志を持つ。\n"
                    "- **特徴**：共感力の塊。感情と論理をバランスよく使いこなす。\n"
                    "- **著名人**：マザー・テレサ、ガンジー、スラムダンクの赤木剛憲\n\n"
                    "---\n\n"
                    "### **INFP（仲介者）**\n"
                    "- **どんな人？**：心優しく、理想と現実のギャップに悩むロマンチスト。\n"
                    "- **傾向**：マイワールド持ち。共感力が高く、人の痛みに敏感。\n"
                    "- **特徴**：芸術肌。自分の「好き」を大切に生きる。\n"
                    "- **著名人**：ジョン・レノン、シェイクスピア、星野源\n\n"
                    "---\n\n"
                    "### **ENFJ（主人公）**\n"
                    "- **どんな人？**：人の力を引き出す天才。カリスマ性があり人気者。\n"
                    "- **傾向**：人間関係に長けていて、人をまとめるのが得意。\n"
                    "- **特徴**：「どうやったらこの人が輝けるか」を常に考えている。\n"
                    "- **著名人**：オプラ・ウィンフリー、バラク・オバマ、松岡修造\n\n"
                    "---\n\n"
                    "### **ENFP（運動家）**\n"
                    "- **どんな人？**：感情豊かで、好奇心が爆発している自由人。\n"
                    "- **傾向**：ノリと勢いで新しいことに飛び込む。人の話をよく聞く。\n"
                    "- **特徴**：アイデア豊富、だけど飽き性。多才なエネルギー体。\n"
                    "- **著名人**：ロビン・ウィリアムズ、ディズニー、ひろゆき\n\n"
                    "---\n\n"
                    "## 🛡️ Sentinels（現実主義者タイプ）\n\n"
                    "---\n\n"
                    "### **ISTJ（管理者）**\n"
                    "- **どんな人？**：真面目で堅実、責任感の塊。\n"
                    "- **傾向**：ルールと信頼が大事。計画的に物事を進める。\n"
                    "- **特徴**：職人肌。淡々と、でも着実に成果を出すタイプ。\n"
                    "- **著名人**：ジョージ・ワシントン、ナウシカのクロトワ、乃木希典\n\n"
                    "---\n\n"
                    "### **ISFJ（擁護者）**\n"
                    "- **どんな人？**：思いやりと献身に満ちた癒し系。\n"
                    "- **傾向**：縁の下の力持ち。裏で支えることに喜びを感じる。\n"
                    "- **特徴**：控えめだけど芯は強い。記憶力も良い。\n"
                    "- **著名人**：ビヨンセ、エリザベス女王、田中みな実\n\n"
                    "---\n\n"
                    "### **ESTJ（幹部）**\n"
                    "- **どんな人？**：組織やルールを大切にする実務家。\n"
                    "- **傾向**：リーダー気質で、責任感が強く頼られる存在。\n"
                    "- **特徴**：効率最優先。感情よりも実績を重視する。\n"
                    "- **著名人**：ミシェル・オバマ、エイブラハム・リンカーン\n\n"
                    "---\n\n"
                    "### **ESFJ（領事）**\n"
                    "- **どんな人？**：社交性と面倒見の良さで人を引きつけるムードメーカー。\n"
                    "- **傾向**：周囲の期待に応えようとする努力家。\n"
                    "- **特徴**：親しみやすく、礼儀正しく、伝統を大切にする。\n"
                    "- **著名人**：テイラー・スウィフト、ホイットニー・ヒューストン\n\n"
                    "---\n\n"
                    "## 🎨 Explorers（冒険家タイプ）\n\n"
                    "---\n\n"
                    "### **ISTP（巨匠）**\n"
                    "- **どんな人？**：クールで現場主義、実際にやってみないと気が済まない。\n"
                    "- **傾向**：無口だけど器用。突発的な問題に強い。\n"
                    "- **特徴**：マニュアルより触って覚えるタイプ。\n"
                    "- **著名人**：クリント・イーストウッド、リヴァイ兵長\n\n"
                    "---\n\n"
                    "### **ISFP（冒険家）**\n"
                    "- **どんな人？**：感性と自由を愛するアーティスト。\n"
                    "- **傾向**：美しいものが好き。マイペースで心優しい。\n"
                    "- **特徴**：目立たないけど、芯がある。行動で語るタイプ。\n"
                    "- **著名人**：マイケル・ジャクソン、オードリー・ヘプバーン\n\n"
                    "---\n\n"
                    "### **ESTP（起業家）**\n"
                    "- **どんな人？**：即行動！今この瞬間を楽しむエンターテイナー。\n"
                    "- **傾向**：リスクを恐れず突き進む。説得力がある。\n"
                    "- **特徴**：「まずやってみる」精神。カリスマ性高め。\n"
                    "- **著名人**：アーネスト・ヘミングウェイ、ジョン・F・ケネディ\n\n"
                    "---\n\n"
                    "### **ESFP（エンターテイナー）**\n"
                    "- **どんな人？**：その場の雰囲気を一気に明るくする人間太陽☀️\n"
                    "- **傾向**：自分も周りも楽しませたい。おしゃべり大好き。\n"
                    "- **特徴**：人気者だけど繊細。感情に正直。\n"
                    "- **著名人**：マリリン・モンロー、フレディ・マーキュリー",
                ),
            ]
        )
        # ペルソナ生成のためのチェーンを作成
        chain = prompt | self.llm
        # ペルソナを生成
        return chain.invoke({"user_input": user_input})
